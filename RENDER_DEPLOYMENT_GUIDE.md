# Metropolis Parking Management - Render.com Deployment Guide

## Issues Fixed

### 1. **Port Configuration** ‚úÖ
- **Problem**: Local batch file was setting `PORT=5000` but Render uses dynamic ports
- **Fix**: Updated to `PORT=10000` (default) and app correctly reads from `os.environ.get('PORT')`

### 2. **Missing Render Configuration** ‚úÖ
- **Problem**: No `render.yaml` configuration file
- **Fix**: Created `render.yaml` with proper web service configuration

### 3. **Platform-Specific Scripts** ‚úÖ
- **Problem**: Batch file uses Windows-specific commands
- **Fix**: Created `start.sh` for Linux deployment on Render

### 4. **Auto Token Refresh** ‚ö†Ô∏è
- **Issue**: Selenium requires browser drivers (Chrome/Firefox/Edge)
- **Note**: Won't work on Render.com free tier - disable `AUTO_TOKEN_REFRESH`
- **Solution**: Set `AUTO_TOKEN_REFRESH=false` in environment variables

## Quick Start - Deploy to Render.com

### Option 1: Using render.yaml (Recommended)

1. **Push code to GitHub**
   ```bash
   git init
   git add .
   git commit -m "Initial commit for Render deployment"
   git remote add origin <your-github-repo-url>
   git push -u origin main
   ```

2. **Connect to Render.com**
   - Go to https://render.com
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Render will auto-detect `render.yaml`

3. **Set Required Environment Variables** (in Render Dashboard)
   ```
   ADMIN_PASSWORD=<your-secure-password>
   AUTH_KEY=<your-metropolis-api-token>
   EMAIL=security@555capitolmall.com
   PASSWORD=<your-metropolis-password>
   SECRET_KEY=<auto-generated-by-render>
   AUTO_TOKEN_REFRESH=false
   ```

4. **Deploy**
   - Click "Create Web Service"
   - Render will build and deploy automatically

### Option 2: Manual Setup

1. **Create New Web Service** on Render
   - Environment: Python
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `gunicorn app:app` or `./start.sh`

2. **Set Environment Variables** (same as above)

3. **Deploy**

## Environment Variables Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `SECRET_KEY` | Yes | Auto-generated | Flask session secret |
| `ADMIN_PASSWORD` | Yes | admin555 | Admin login password |
| `AUTH_KEY` | Yes | (hardcoded) | Metropolis API Bearer token |
| `BASE_URL` | No | https://specialist.api.metropolis.io | Metropolis API endpoint |
| `SITE_ID` | No | 4005 | Primary site ID |
| `EMAIL` | Yes | (hardcoded) | Metropolis login email |
| `PASSWORD` | Yes | (hardcoded) | Metropolis login password |
| `AUTO_TOKEN_REFRESH` | No | false | Enable Selenium auto-refresh (not supported on Render) |
| `PORT` | No | 10000 | Port (set by Render automatically) |

## Important Security Notes

‚ö†Ô∏è **CRITICAL**: Do NOT commit sensitive credentials to Git!

1. **Remove hardcoded credentials** from `app.py` before deploying
2. Set all sensitive values as environment variables in Render dashboard
3. Add `.env` to `.gitignore` if you create one

## Testing Your Deployment

1. **Check deployment logs** in Render dashboard
2. **Access your app** at: `https://your-app-name.onrender.com`
3. **Login** with your `ADMIN_PASSWORD`
4. **Test token** using the "Test Token" button on dashboard

## Troubleshooting

### Issue: App crashes on startup
- **Check logs** for missing environment variables
- **Verify** all required env vars are set in Render dashboard

### Issue: Token invalid/expired
- **Manually update** `AUTH_KEY` environment variable
- **Restart** the service after updating

### Issue: Selenium errors
- **Set** `AUTO_TOKEN_REFRESH=false`
- Selenium doesn't work on Render free tier (no browser drivers)

### Issue: Port binding errors
- **Don't set** `PORT` manually - let Render set it
- App correctly uses `os.environ.get('PORT', 10000)`

## Local Testing (Windows)

Run `run-local.bat` to test locally:
```cmd
run-local.bat
```

This will:
1. Create virtual environment
2. Install dependencies
3. Prompt for Selenium setup (optional)
4. Start server at http://localhost:10000

## Production vs Development

| Feature | Local (run-local.bat) | Render.com |
|---------|----------------------|------------|
| Platform | Windows | Linux |
| Port | 10000 | Dynamic (set by Render) |
| Selenium | Optional | Not available |
| Token Refresh | Optional (if Selenium installed) | Manual only |
| Environment | Virtual env | Container |

## Next Steps

1. ‚úÖ Push code to GitHub
2. ‚úÖ Create Render account
3. ‚úÖ Deploy using render.yaml
4. ‚úÖ Set environment variables
5. ‚úÖ Test deployment
6. üîÑ Monitor logs
7. üîÑ Update AUTH_KEY when expired

## Files Added for Render Deployment

- `render.yaml` - Render service configuration
- `start.sh` - Production startup script
- `RENDER_DEPLOYMENT_GUIDE.md` - This file

## Files Modified

- `run-local.bat` - Fixed port from 5000 to 10000
- `requirements.txt` - Added note about Selenium limitations
